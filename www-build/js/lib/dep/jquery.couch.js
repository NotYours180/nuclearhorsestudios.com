define(["jquery"],function($){function encodeDocId(docID){var parts=docID.split("/");return"_design"==parts[0]?(parts.shift(),"_design/"+encodeURIComponent(parts.join("/"))):encodeURIComponent(docID)}function ajax(obj,options,errorMessage,ajaxOptions){var timeStart,defaultAjaxOpts={contentType:"application/json",headers:{Accept:"application/json"}};options=$.extend({successStatus:200},options),ajaxOptions=$.extend(defaultAjaxOpts,ajaxOptions),errorMessage=errorMessage||"Unknown error",timeStart=(new Date).getTime(),$.ajax($.extend($.extend({type:"GET",dataType:"json",cache:!0,beforeSend:function(xhr){if(ajaxOptions&&ajaxOptions.headers)for(var header in ajaxOptions.headers)xhr.setRequestHeader(header,ajaxOptions.headers[header])},complete:function(req){var reqDuration=(new Date).getTime()-timeStart;try{console.log("responsetext",req.responseText);var resp=$.parseJSON(req.responseText)}catch(e){if(!options.error)throw errorMessage+": "+e;return options.error(req.status,req,e),void 0}if(options.ajaxStart&&options.ajaxStart(resp),req.status==options.successStatus)options.beforeSuccess&&options.beforeSuccess(req,resp,reqDuration),options.success&&options.success(resp,reqDuration);else{if(!options.error)throw errorMessage+": "+resp.reason;options.error(req.status,resp&&resp.error||errorMessage,resp&&resp.reason||"no response",reqDuration)}}},obj),ajaxOptions))}function fullCommit(options){var options=options||{};if("undefined"!=typeof options.ensure_full_commit){var commit=options.ensure_full_commit;return delete options.ensure_full_commit,function(xhr){xhr.setRequestHeader("Accept","application/json"),xhr.setRequestHeader("X-Couch-Full-Commit",commit.toString())}}}function encodeOptions(options){var buf=[];if("object"==typeof options&&null!==options)for(var name in options)if(!($.inArray(name,["error","success","beforeSuccess","ajaxStart"])>=0)){var value=options[name];$.inArray(name,["key","startkey","endkey"])>=0&&(value=toJSON(value)),buf.push(encodeURIComponent(name)+"="+encodeURIComponent(value))}return buf.length?"?"+buf.join("&"):""}function toJSON(obj){return null!==obj?JSON.stringify(obj):null}$.couch=$.couch||{};var uuidCache=[];$.extend($.couch,{urlPrefix:"",activeTasks:function(options){ajax({url:this.urlPrefix+"/_active_tasks"},options,"Active task status could not be retrieved")},allDbs:function(options){ajax({url:this.urlPrefix+"/_all_dbs"},options,"An error occurred retrieving the list of all databases")},config:function(options,section,option,value){var req={url:this.urlPrefix+"/_config/"};section&&(req.url+=encodeURIComponent(section)+"/",option&&(req.url+=encodeURIComponent(option))),null===value?req.type="DELETE":void 0!==value&&(req.type="PUT",req.data=toJSON(value),req.contentType="application/json",req.processData=!1),ajax(req,options,"An error occurred retrieving/updating the server configuration")},session:function(options){options=options||{},ajax({type:"GET",url:this.urlPrefix+"/_session",beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json")},complete:function(req){var resp=$.parseJSON(req.responseText);if(200==req.status)options.success&&options.success(resp);else{if(!options.error)throw"An error occurred getting session info: "+resp.reason;options.error(req.status,resp.error,resp.reason)}}})},userDb:function(callback){$.couch.session({success:function(resp){var userDb=$.couch.db(resp.info.authentication_db);callback(userDb)}})},signup:function(user_doc,password,options){options=options||{},user_doc.password=password,user_doc.roles=user_doc.roles||[],user_doc.type=user_doc.type="user";var user_prefix="org.couchdb.user:";user_doc._id=user_doc._id||user_prefix+user_doc.name,$.couch.userDb(function(db){db.saveDoc(user_doc,options)})},login:function(options){options=options||{},$.ajax({type:"POST",url:this.urlPrefix+"/_session",dataType:"json",data:{name:options.name,password:options.password},beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json")},complete:function(req){var resp=$.parseJSON(req.responseText);if(200==req.status)options.success&&options.success(resp);else{if(!options.error)throw"An error occurred logging in: "+resp.reason;options.error(req.status,resp.error,resp.reason)}}})},logout:function(options){options=options||{},$.ajax({type:"DELETE",url:this.urlPrefix+"/_session",dataType:"json",username:"_",password:"_",beforeSend:function(xhr){xhr.setRequestHeader("Accept","application/json")},complete:function(req){var resp=$.parseJSON(req.responseText);if(200==req.status)options.success&&options.success(resp);else{if(!options.error)throw"An error occurred logging out: "+resp.reason;options.error(req.status,resp.error,resp.reason)}}})},db:function(name,db_opts){function maybeApplyVersion(doc){if(doc._id&&doc._rev&&rawDocs[doc._id]&&rawDocs[doc._id].rev==doc._rev){if("undefined"==typeof Base64)throw"Base64 support not found.";return doc._attachments=doc._attachments||{},doc._attachments["rev-"+doc._rev.split("-")[0]]={content_type:"application/json",data:Base64.encode(rawDocs[doc._id].raw)},!0}}db_opts=db_opts||{};var rawDocs={};return{name:name,uri:this.urlPrefix+"/"+encodeURIComponent(name)+"/",compact:function(options){$.extend(options,{successStatus:202}),ajax({type:"POST",url:this.uri+"_compact",data:"",processData:!1},options,"The database could not be compacted")},viewCleanup:function(options){$.extend(options,{successStatus:202}),ajax({type:"POST",url:this.uri+"_view_cleanup",data:"",processData:!1},options,"The views could not be cleaned up")},compactView:function(groupname,options){$.extend(options,{successStatus:202}),ajax({type:"POST",url:this.uri+"_compact/"+groupname,data:"",processData:!1},options,"The view could not be compacted")},create:function(options){$.extend(options,{successStatus:201}),ajax({type:"PUT",url:this.uri,contentType:"application/json",data:"",processData:!1},options,"The database could not be created")},drop:function(options){ajax({type:"DELETE",url:this.uri},options,"The database could not be deleted")},info:function(options){ajax({url:this.uri},options,"Database information could not be retrieved")},changes:function(since,options){function triggerListeners(resp){$.each(listeners,function(){this(resp)})}function getChangesSince(){var opts=$.extend({heartbeat:1e4},options,{feed:"longpoll",since:since});ajax({url:db.uri+"_changes"+encodeOptions(opts)},options,"Error connecting to "+db.uri+"/_changes.")}options=options||{};var timeout=100,db=this,active=!0,listeners=[],promise={onChange:function(fun){listeners.push(fun)},stop:function(){active=!1}};return options.success=function(resp){timeout=100,active&&(since=resp.last_seq,triggerListeners(resp),getChangesSince())},options.error=function(){active&&(setTimeout(getChangesSince,timeout),timeout=2*timeout)},since?getChangesSince():db.info({success:function(info){since=info.update_seq,getChangesSince()}}),promise},allDocs:function(options){var type="GET",data=null;if(options.keys){type="POST";var keys=options.keys;delete options.keys,data=toJSON({keys:keys})}ajax({type:type,data:data,url:this.uri+"_all_docs"+encodeOptions(options)},options,"An error occurred retrieving a list of all documents")},allDesignDocs:function(options){this.allDocs($.extend({startkey:"_design",endkey:"_design0"},options))},allApps:function(options){options=options||{};var self=this;if(!options.eachApp)throw"Please provide an eachApp function for allApps()";this.allDesignDocs({success:function(resp){$.each(resp.rows,function(){self.openDoc(this.id,{success:function(ddoc){var index,appPath,appName=ddoc._id.split("/");appName.shift(),appName=appName.join("/"),index=ddoc.couchapp&&ddoc.couchapp.index,index?appPath=["",name,ddoc._id,index].join("/"):ddoc._attachments&&ddoc._attachments["index.html"]&&(appPath=["",name,ddoc._id,"index.html"].join("/")),appPath&&options.eachApp(appName,appPath,ddoc)}})})}})},openDoc:function(docId,options,ajaxOptions){options=options||{},db_opts.attachPrevRev||options.attachPrevRev?$.extend(options,{beforeSuccess:function(req,doc){rawDocs[doc._id]={rev:doc._rev,raw:req.responseText}}}):$.extend(options,{beforeSuccess:function(req,doc){doc["jquery.couch.attachPrevRev"]&&(rawDocs[doc._id]={rev:doc._rev,raw:req.responseText})}}),ajax({url:this.uri+encodeDocId(docId)+encodeOptions(options)},options,"The document could not be retrieved",ajaxOptions)},saveDoc:function(doc,options){options=options||{};var db=this,beforeSend=fullCommit(options);if(void 0===doc._id)var method="POST",uri=this.uri;else var method="PUT",uri=this.uri+encodeDocId(doc._id);var versioned=maybeApplyVersion(doc);$.ajax({type:method,url:uri+encodeOptions(options),contentType:"application/json",dataType:"json",data:toJSON(doc),beforeSend:beforeSend,complete:function(req){var resp=$.parseJSON(req.responseText);if(200==req.status||201==req.status||202==req.status)doc._id=resp.id,doc._rev=resp.rev,versioned?db.openDoc(doc._id,{attachPrevRev:!0,success:function(d){doc._attachments=d._attachments,options.success&&options.success(resp)}}):options.success&&options.success(resp);else{if(!options.error)throw"The document could not be saved: "+resp.reason;options.error(req.status,resp.error,resp.reason)}}})},bulkSave:function(docs,options){var beforeSend=fullCommit(options);$.extend(options,{successStatus:201,beforeSend:beforeSend}),ajax({type:"POST",url:this.uri+"_bulk_docs"+encodeOptions(options),contentType:"application/json",data:toJSON(docs)},options,"The documents could not be saved")},removeDoc:function(doc,options){ajax({type:"DELETE",url:this.uri+encodeDocId(doc._id)+encodeOptions({rev:doc._rev})},options,"The document could not be deleted")},bulkRemove:function(docs,options){docs.docs=$.each(docs.docs,function(i,doc){doc._deleted=!0}),$.extend(options,{successStatus:201}),ajax({type:"POST",url:this.uri+"_bulk_docs"+encodeOptions(options),data:toJSON(docs)},options,"The documents could not be deleted")},copyDoc:function(docId,options,ajaxOptions){ajaxOptions=$.extend(ajaxOptions,{complete:function(req){var resp=$.parseJSON(req.responseText);if(201==req.status)options.success&&options.success(resp);else{if(!options.error)throw"The document could not be copied: "+resp.reason;options.error(req.status,resp.error,resp.reason)}}}),ajax({type:"COPY",url:this.uri+encodeDocId(docId)},options,"The document could not be copied",ajaxOptions)},query:function(mapFun,reduceFun,language,options){language=language||"javascript","string"!=typeof mapFun&&(mapFun=mapFun.toSource?mapFun.toSource():"("+mapFun.toString()+")");var body={language:language,map:mapFun};null!=reduceFun&&("string"!=typeof reduceFun&&(reduceFun=reduceFun.toSource?reduceFun.toSource():"("+reduceFun.toString()+")"),body.reduce=reduceFun),ajax({type:"POST",url:this.uri+"_temp_view"+encodeOptions(options),contentType:"application/json",data:toJSON(body)},options,"An error occurred querying the database")},list:function(list,view,options,ajaxOptions){var list=list.split("/"),options=options||{},type="GET",data=null;if(options.keys){type="POST";var keys=options.keys;delete options.keys,data=toJSON({keys:keys})}ajax({type:type,data:data,url:this.uri+"_design/"+list[0]+"/_list/"+list[1]+"/"+view+encodeOptions(options)},ajaxOptions,"An error occured accessing the list")},view:function(name,options){var name=name.split("/"),options=options||{},type="GET",data=null;if(options.keys){type="POST";var keys=options.keys;delete options.keys,data=toJSON({keys:keys})}ajax({type:type,data:data,url:this.uri+"_design/"+name[0]+"/_view/"+name[1]+encodeOptions(options)},options,"An error occurred accessing the view")},getDbProperty:function(propName,options,ajaxOptions){ajax({url:this.uri+propName+encodeOptions(options)},options,"The property could not be retrieved",ajaxOptions)},setDbProperty:function(propName,propValue,options,ajaxOptions){ajax({type:"PUT",url:this.uri+propName+encodeOptions(options),data:JSON.stringify(propValue)},options,"The property could not be updated",ajaxOptions)}}},encodeDocId:encodeDocId,info:function(options){ajax({url:this.urlPrefix+"/"},options,"Server information could not be retrieved")},replicate:function(source,target,ajaxOptions,repOpts){repOpts=$.extend({source:source,target:target},repOpts),repOpts.continuous&&!repOpts.cancel&&(ajaxOptions.successStatus=202),ajax({type:"POST",url:this.urlPrefix+"/_replicate",data:JSON.stringify(repOpts),contentType:"application/json"},ajaxOptions,"Replication failed")},newUUID:function(cacheNum){return void 0===cacheNum&&(cacheNum=1),uuidCache.length||ajax({url:this.urlPrefix+"/_uuids",data:{count:cacheNum},async:!1},{success:function(resp){uuidCache=resp.uuids}},"Failed to retrieve UUID batch."),uuidCache.shift()}})});